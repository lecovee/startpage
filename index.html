<!DOCTYPE html>
 <html lang="en"  style="background-image: url('background/background1.jpg');background-size:cover"> 
  <head>
    <meta charset="UTF-8">
    <title>my home page</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="theme-color" content="#0019B5">
  </head>


  <body onload="onload()">
	<div class="row">
  		<a class="icon" id="amazon" href="https://smile.amazon.de/-/en/gp/video/storefront/ref=atv_nb_free_to_me?language=en&clientFilter=on">
    			<img class="image" src="thumbnails/amazon.svg" alt="amazon" style="width:100%">
			<!-- alt: href="https://smile.amazon.de/-/en/gp/video/storefront/ref=atv_nb_free_to_me?language=en" -->
  		</a>

  		<a class="icon" href="https://youtube.com">
    			<img class="image" src="thumbnails/youtube.svg" alt="youtube" style="width:100%">
  		</a>

  		<a class="icon" href="https://netflix.com">
    			<img class="image" src="thumbnails/netflix.svg" alt="netflix" style="width:100%">
  		</a>
  				
		
		<a class="icon" id="tagesschau" href="https://www.youtube.com/embed/videoseries?index=0&amp;list=PL4A2F331EE86DCC22">
    			<img class="image" id="tagesschauImage" src="thumbnails/tagesschauInactive.svg" alt="tagesschau" style="width:100%">
  		</a>
	

		<!--
  		<a class="icon" href="https://www.twitch.tv">
    			<img class="image" src="thumbnails/twitch.svg" alt="twitch" style="width:100%">
  		</a>
		-->
		
		<!--
  		<a class="icon" href="https://www.ardmediathek.de/sendung/kevin-kuehnert-und-die-spd/staffel-1/Y3JpZDovL25kci5kZS80NzI4/1/">
    			<img class="image" src="thumbnails/miscellaneous.svg" alt="miscellaneous" style="width:100%">
  		</a>
		-->
		
  		<a class="icon" id="whatsapp" href="https://web.whatsapp.com">
    			<img class="image" src="thumbnails/whatsapp.svg" alt="whatsapp" style="width:100%">
  		</a>
		
  		<a class="icon" id="alternative" href="https://www.zdf.de/comedy/zdf-magazin-royale">
    			<img class="image" src="thumbnails/zdf_magazin.svg" alt="zdf magazin" style="width:100%">
  		</a>
	</div>
    
    <div class="bottomRightIcon" onclick="onClickSettingsButton()"></div>

  </body>
  <script>
	// --- constants ---
	//cookie names
	var googleApiKeyCookieName = "googleApiKey";
	var usageCookieName = "usage";
	var tagesschauUpdatedTimeCookieName = "tagesschauUpdatedTime";
	var tagesschauLinkCookieName = "tagesschauLink";

	//variables
	var usageMedia = "media";
	var usageDesktop = "desktop";
	var usageDefault = usageDesktop;
	var youtubeCheckTimeOut = 60; // in min
	var refreshTime = 127;		// in min

	var anyCookieSet = 0;

	//detect firefox
	if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){
		adjustForUse(usageDefault)
     		// firefox macht probleme
		// wenn ich die site als new tab habe und cookies beim beenden lösche dann löscht es auch die cookies von dieser site
		// auch wenn sie eigentlich als exceptions drin steht
		// blöde lösung -> firefox macht nix mit cookies und hat nur standard ansicht
		throw new Error("firefox kann new tab cookies nicht exceptionieren also macht firefox nix mit cookies");
	}

	//main
	
	usage = getCookie(usageCookieName);
	if (usage != 0){
        adjustForUse(usage);
	}
	

	function onClickSettingsButton(){
        openSettingsInputs();
	}
	
	function openSettingsInputs(){
        usageInt = prompt("enter usage\n0=desktop\n1=media\n-1=default",-1);
		if (usageInt == 0) {
			thisUsage = usageDesktop;
		}
		else if (usageInt == 1){
			thisUsage = usageMedia;
		}
		else {
            thisUsage = usageDefault;
		}
		setCookie(usageCookieName, thisUsage);
		
		googleApiKey = prompt("enter my google api", getCookie(googleApiKeyCookieName));
		setCookie(googleApiKeyCookieName, googleApiKey);
		
		
		refreshPage();
	}	
	
	function onload(){
		
		//detect firefox
		if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){
			// firefox macht probleme
			// wenn ich die site als new tab habe und cookies beim beenden lösche dann löscht es auch die cookies von dieser site
			// auch wenn sie eigentlich als exceptions drin steht
			// blöde lösung -> firefox macht nix mit cookies und hat nur standard ansicht
			throw new Error("firefox kann new tab cookies nicht exceptionieren also macht firefox nix mit cookies");
		}
		
		if (getCookie(googleApiKeyCookieName).length != 0){
            tagesschauMain();
		}
		
		
		// refresh page after some time
		setTimeout(refreshPage, refreshTime*60*1000);
		
	}

	function refreshPage(){
		location.reload();
	}

	function tagesschauMain(){
		// main function to do the tagesschau stuff
		// anscheinend geht $ nicht direkt aber über onload gehts
		// google api key exceeds mögliche lösung check nur höchsten x mal am tag und save last youtube id als cookie
		
		let tagesschauUpdateTime = getCookie(tagesschauUpdatedTimeCookieName);
		let now = new Date().getTime();
		if (tagesschauUpdateTime.length === 0){
			// cookie not set -> update
			updateTagesschauLink(googleApiKey, now);			
		}
		else {
			if (tagesschauUpdateTime < now - youtubeCheckTimeOut*60*1000) {
				// last youtube check was longer then youtubeCheckTimeOut min ago -> update
				updateTagesschauLink(googleApiKey, now);				
			}
			else {
				setTagesschauLink(getCookie(tagesschauLinkCookieName));
			}
		}	
	}

	function adjustForUse(usage){
		if(usage.length===0){
			usage = usageDefault;
		}
		if(usage===usageMedia){
			removeElement("whatsapp");			
			return;
		}
		else if (usage === usageDesktop){
			removeElement("alternative");
			document.getElementById("amazon").setAttribute("href","https://smile.amazon.de/");
			return;
		}
		else {
			alert("hi");
		}				
	}
	function removeElement(id) {
		document.getElementById(id).outerHTML = "";
	}
  	function setTagesschauLink(link){
  		let tagesschauIcon = document.getElementById("tagesschau");
  		tagesschauIcon.setAttribute("href",link);
  	}
	function setTagesschauImageReady(){
		$(document).ready(function() {
			document.getElementById("tagesschauImage").src = "thumbnails/tagesschau.svg";
		});
	}
  	function getTagesschauQuery(){
  		let date = new Date();
  		date.setDate(date.getDate()-1); 
  		let dateString = getTwoDigitsValue(date.getDate())+"."+getTwoDigitsValue(date.getMonth()+1)+"."+date.getFullYear();
  		return "tagesschau+20:00+uhr+"+"\""+dateString+"\"";
  	}
  	function getTwoDigitsValue(value){
  		if (value < 10){
  			answer = "0"+value;
  		} else {
  			answer = value;
  		}
  		return answer;
  	}
	function updateTagesschauLink(thisGoogleApiKey, timeNow) {
        if (thisGoogleApiKey.lenth===0){
            return;
        }
		let searchlink = "https://www.googleapis.com/youtube/v3/search?part=snippet";
		searchlink = searchlink + "&q="+getTagesschauQuery();			// tagesschau 20:00 uhr 02.07.1993
		searchlink = searchlink + "&channelId=UC5NOEUbkLheQcaaRldYW5GA";	// channel tagesschau
		searchlink = searchlink + "&key="+thisGoogleApiKey;			// youtube api key
		console.log("searchlink = " + searchlink)
		let searchQuery = 
		$.get(searchlink,function(data){
			let responseString = JSON.stringify(data);
			let videoIdPosition = responseString.indexOf("videoId");
			let videoId = responseString.substring(videoIdPosition+10,videoIdPosition+21);
	  		let link = "https://www.youtube.com/watch?v="+videoId
			setTagesschauLink(link);
			setTagesschauImageReady();
			setCookie(tagesschauUpdatedTimeCookieName, timeNow);
			setCookie(tagesschauLinkCookieName, link);
		});
	}
	function setCookie(cookieName, cookieValue) {
		document.cookie = cookieName + "="+cookieValue+";";
	}
	function getCookie(cname) {
		// from https://www.w3schools.com/js/js_cookies.asp
		let name = cname + "=";
		let decodedCookie = decodeURIComponent(document.cookie);
		let ca = decodedCookie.split(';');
		for(let i = 0; i <ca.length; i++) {
			let c = ca[i];
			while (c.charAt(0) == ' ') {
				c = c.substring(1);
			}
			if (c.indexOf(name) == 0) {
				return c.substring(name.length, c.length);
			}
		}
		return "";
	}
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</body>
</html>
